version: "{build}"
clone_folder: "c:\\network"

environment:
  global:
    CABOPTS:  "--store-dir=C:\\SR --http-transport=plain-http"
  matrix:
    - GHCVER: "7.10.3.2"
      DOCTEST: "NO"

platform:
#  - x86 # We may want to test x86 as well, but it would double the 23min build time.
  - x64

init:
 - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

cache:
 - "C:\\SR"

install:
 - "choco install -y cabal"
 - "choco install -y ghc --version %GHCVER%"
 - "refreshenv"
 - "set PATH=C:\\msys64\\mingw64\\bin;C:\\msys64\\usr\\bin;C:\\ghc\\ghc-%GHCVER%\\bin;%PATH%"
 - "cabal --version"
 - "ghc --version"
 - "cabal %CABOPTS% update -vverbose+nowrap"
 - "cabal %CABOPTS% install hspec-discover"
 - "cabal %CABOPTS% install cabal-doctest"


on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))


build: off
deploy: off

test_script:
 - IF EXIST configure.ac bash -c "autoreconf -i"
 - "cabal %CABOPTS% new-build -j1 -vnormal+nowrap --dry all"
 - ps: Push-AppveyorArtifact dist-newstyle\cache\plan.json
 - "cabal %CABOPTS% new-build -j1 -vnormal+nowrap all"
 - IF "%DOCTEST%"=="YES" (set TESTSUITE=all) ELSE (set TESTSUITE=network:test:spec)
 - "cabal %CABOPTS% new-test  -j1 -vnormal+nowrap %TESTSUITE%"
 - ps: ls network*.log -recurse | %{ Push-AppveyorArtifact $_}
